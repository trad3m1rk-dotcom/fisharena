function endSessionEarly() {
            if (!sessionActive) return;
            
            const timeUsed = (Date.now() - sessionStartTime) / 1000;
            const minutesUsed = timeUsed / 60;
            const minutesRemaining = SESSION_DURATION - minutesUsed;
            const refund = minutesRemaining * SESSION_COST_PER_MINUTE;
            
            if (minutesRemaining > 0 && refund > 0) {
                const confirmEnd = confirm(
                    `End session now?\n\n` +
                    `Time used: ${minutesUsed.toFixed(1)} min\n` +
                    `Time remaining: ${minutesRemaining.toFixed(1)} min\n` +
                    `Refund: â‚¬${refund.toFixed(2)}\n\n` +
                    `Click OK to end and get refund.`
                );
                
                if (confirmEnd) {
                    userBalance += refund;
                    updateBalance();
                    endSession();
                    showNotification(`âœ… Session ended! â‚¬${refund.toFixed(2)} refunded`);
                }
            } else {
                endSession();
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                const timerElement = document.getElementById('timer');
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 30) timerElement.classList.add('warning');
                if (timeLeft <= 0) endSession();
            }, 1000);
        }

        function endSession() {
            clearInterval(timerInterval);
            sessionActive = false;
            timeLeft = 300;
            
            document.getElementById('controls').style.display = 'none';
            document.getElementById('videoOverlay').classList.remove('hidden');
            document.getElementById('userStatus').textContent = 'Session Ended';
            document.getElementById('timer').classList.remove('warning');
            
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
            
            showNotification('â° Session ended! Balance: â‚¬' + userBalance.toFixed(2));
        }

        // ============ BOOST PURCHASES ============
        function buyBoost(boostType, price) {
            if (!sessionActive) {
                showNotification('âš ï¸ Start a session first!');
                return;
            }
            
            if (userBalance < price) {
                showNotification(`âš ï¸ Insufficient balance! Need â‚¬${price.toFixed(2)}`);
                return;
            }
            
            deductBalance(price);
            sendCommand(boostType);
            showNotification(`âœ… ${boostType.toUpperCase()} activated! â‚¬${price.toFixed(2)} spent`);
        }

        function sendCommand(command) {
            const commands = {
                'cast': 'ðŸŽ£ Casting bait...',
                'reel': 'ðŸ”„ Reeling in...',
                'hook': 'âš¡ Hook set!',
                'rotate-left': 'â†¶ Rotating left...',
                'rotate-right': 'â†· Rotating right...',
                'lower': 'â¬‡ï¸ Lowering rod...',
                'turbo': 'ðŸš€ Turbo mode activated!'
            };
            
            showNotification(commands[command]);
            console.log('Command sent:', command, new Date().toISOString());
            
            setTimeout(() => {
                addChatMessage('System', `Command "${command}" executed âœ…`);
            }, 500);
        }

        // ============ KEYBOARD CONTROLS ============
        document.addEventListener('keydown', function(e) {
            if (!sessionActive) return;
            
            const gameKeys = ['a', 's', 'd', '1', '2', '3', ' ', 'f'];
            if (gameKeys.includes(e.key.toLowerCase())) {
                e.preventDefault();
            }
            
            switch(e.key.toLowerCase()) {
                case 'a':
                    sendCommand('rotate-left');
                    break;
                case 's':
                    sendCommand('lower');
                    break;
                case 'd':
                    sendCommand('rotate-right');
                    break;
                case '1':
                    buyBoost('cast', 0.50);
                    break;
                case '2':
                    buyBoost('reel', 0.30);
                    break;
                case '3':
                    buyBoost('hook', 0.40);
                    break;
                case ' ':
                    buyBoost('turbo', 1.00);
                    break;
                case 'f':
                    toggleFullscreen();
                    break;
            }
        });

        // ============ FULLSCREEN MODE ============
        function toggleFullscreen() {
            const videoSection = document.getElementById('videoSection');
            
            if (!document.fullscreenElement) {
                videoSection.requestFullscreen().then(() => {
                    videoSection.classList.add('fullscreen-mode');
                    if (document.getElementById('fullscreenBtn')) {
                        document.getElementById('fullscreenBtn').querySelector('.control-label').textContent = 'Exit FS';
                    }
                }).catch(err => {
                    console.log('Fullscreen error:', err);
                    showNotification('âš ï¸ Fullscreen not supported');
                });
            } else {
                document.exitFullscreen().then(() => {
                    videoSection.classList.remove('fullscreen-mode');
                    if (document.getElementById('fullscreenBtn')) {
                        document.getElementById('fullscreenBtn').querySelector('.control-label').textContent = 'Fullscreen';
                    }
                });
            }
        }

        document.addEventListener('fullscreenchange', function() {
            const videoSection = document.getElementById('videoSection');
            if (!document.fullscreenElement) {
                videoSection.classList.remove('fullscreen-mode');
                if (document.getElementById('fullscreenBtn')) {
                    document.getElementById('fullscreenBtn').querySelector('.control-label').textContent = 'Fullscreen';
                }
            }
        });

        function updateTelemetry() {
            if (!sessionActive) return;
            document.getElementById('tension').textContent = (Math.random() * 3).toFixed(1) + ' kg';
            document.getElementById('depth').textContent = Math.floor(Math.random() * 5) + ' m';
            document.getElementById('speed').textContent = (Math.random() * 2).toFixed(1) + ' m/s';
        }

        // ============ CHAT ============
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                addChatMessage('You', message);
                input.value = '';
            }
        }

        function handleChatEnter(event) {
            if (event.key === 'Enter') sendChatMessage();
        }

        function addChatMessage(username, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            messageDiv.innerHTML = `<span class="username">${username}:</span><span>${message}</span>`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ============ CRAZY MENU ============
        function buyCrazy(action, price) {
            if (userBalance < price) {
                showNotification(`âš ï¸ Insufficient balance! Need â‚¬${price}`);
                return;
            }
            
            if (confirm(`Buy "${action}" for â‚¬${price}?`)) {
                deductBalance(price);
                showNotification(`${action} activated! ðŸ”¥ (â‚¬${price} deducted)`);
                addChatMessage('ðŸ’° CRAZY', `Someone bought "${action}" for â‚¬${price}!`);
            }
        }

        // ============ NOTIFICATIONS ============
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        // ============ AUTO-PLAY VIDEOS ============
        window.addEventListener('load', () => {
            document.querySelectorAll('video').forEach(video => {
                video.play().catch(e => console.log('Autoplay blocked'));
            });
        });

        // ============ STATS UPDATE ============
        setInterval(() => {
            const stat = document.getElementById('playersOnline');
            if (stat) {
                const current = parseInt(stat.textContent);
                stat.textContent = Math.max(100, current + Math.floor(Math.random() * 10) - 5);
            }
        }, 3000);
    </script>
</body>
</html>
